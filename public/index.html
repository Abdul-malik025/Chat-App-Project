<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ===== AUTH SCREEN (Login/Signup) ===== -->
  <div class="background" id="authContainer">
    <div class="chat-bubble">
      <span>Chat</span>
    </div>
    <div class="auth-container">
      <!-- Login Card -->
      <div class="auth-card" id="loginCard">
        <h2>Login</h2>
        <form onsubmit="event.preventDefault(); loginUser();">
          <div class="input-group">
            <label for="loginUsername">Username</label>
            <input type="text" id="loginUsername" placeholder="Enter username" />
          </div>
          <div class="input-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" placeholder="Enter password" />
          </div>
          <button type="submit" class="auth-btn">Sign In</button>
          <a href="#" class="forgot-link">Forgot your password?</a>
        </form>
        <p class="switch-link">
          Don't have an account?
          <a href="#" onclick="showSignup()">Sign Up</a>
        </p>
      </div>

      <!-- Signup Card (hidden by default) -->
      <div class="auth-card" id="signupCard" style="display: none;">
        <h2>Sign Up</h2>
        <form onsubmit="event.preventDefault(); registerUser();">
          <div class="input-group">
            <label for="signupUsername">Username</label>
            <input type="text" id="signupUsername" placeholder="Choose a username" />
          </div>
          <div class="input-group">
            <label for="signupPassword">Password</label>
            <input type="password" id="signupPassword" placeholder="Create a password" />
          </div>
          <button type="submit" class="auth-btn">Register</button>
        </form>
        <p class="switch-link">
          Already have an account?
          <a href="#" onclick="showLogin()">Login</a>
        </p>
      </div>
    </div>
  </div>

  <!-- ===== ROOM SELECTION SCREEN ===== -->
  <div id="roomContainer" class="container" style="display: none;">
    <div class="room-card">
      <h2>Select a Room</h2>
      <div class="create-room">
        <input id="newRoomInput" type="text" placeholder="Enter new room name" />
        <button onclick="createRoom()">Create Room</button>
      </div>
      <h3>Or join an existing room:</h3>
      <ul id="roomList"></ul>
      <button class="logout-button" onclick="logoutUser()">Logout</button>
    </div>
  </div>

  <!-- ===== FULL-SCREEN CHAT SCREEN ===== -->
  <!-- IMPORTANT: Do NOT use class="container" on this div -->
  <div id="chatContainer" style="display: none;">
    <div class="chat-card">
      <div class="chat-header">
        <h2>Room: <span id="roomNameDisplay"></span></h2>
        <div class="header-buttons">
          <button class="back-button" onclick="backToRoomSelection()">Back</button>
          <button class="logout-button" onclick="logoutUser()">Logout</button>
          <button class="mode-toggle" onclick="toggleDarkMode()">Toggle Mode</button>
        </div>
      </div>
      <ul id="messages"></ul>
      <div class="chat-input">
        <button id="emojiBtn" onclick="toggleEmojiPicker()">üòä</button>
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <!-- Hidden file input for attachments -->
        <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*" onchange="uploadFile(this)" />
        <button onclick="document.getElementById('fileInput').click()">üìé</button>
        <button onclick="sendMessage()" style = "margin-left:10px">Send</button>
      </div>
      <!-- Emoji Picker -->
      <div id="emojiPicker" style="display: none;">
        <span onclick="addEmoji('üòÄ')">üòÄ</span>
        <span onclick="addEmoji('üòÇ')">üòÇ</span>
        <span onclick="addEmoji('üòç')">üòç</span>
        <span onclick="addEmoji('üòé')">üòé</span>
        <span onclick="addEmoji('üëç')">üëç</span>
        <span onclick="addEmoji('üôè')">üôè</span>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = "";
    let currentRoom = "";

    // Check session on page load
    window.onload = function() {
      fetch("/me")
        .then(response => response.json())
        .then(data => {
          if (data.loggedIn) {
            username = data.user.username;
            document.getElementById("authContainer").style.display = "none";
            document.getElementById("roomContainer").style.display = "block";
            fetchRooms();
          }
        })
        .catch(err => console.error("Error checking session:", err));
      // Apply saved theme
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
      }
    };

    /* ----- SOCKET.IO EVENTS ----- */
    socket.on("connect", () => console.log("Connected to server"));
    socket.on("disconnect", () => console.log("Disconnected from server"));

    socket.on("joined room", roomName => {
      console.log("Successfully joined room:", roomName);
    });

    socket.on("chat history", messages => {
      const messageList = document.getElementById("messages");
      messageList.innerHTML = "";
      messages.forEach(msg => {
        appendMessage(msg.username, msg.message, msg.media, msg.mediaType);
      });
    });

    socket.on("chat message", data => {
      appendMessage(data.username, data.message, data.media, data.mediaType);
    });

    /* ----- LOGIN/SIGNUP FUNCTIONS ----- */
    function showSignup() {
      document.getElementById("loginCard").style.display = "none";
      document.getElementById("signupCard").style.display = "block";
    }

    function showLogin() {
      document.getElementById("signupCard").style.display = "none";
      document.getElementById("loginCard").style.display = "block";
    }

    function loginUser() {
      const loginUsername = document.getElementById("loginUsername").value.trim();
      const loginPassword = document.getElementById("loginPassword").value.trim();
      if (loginUsername && loginPassword) {
        fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: loginUsername, password: loginPassword })
        })
          .then(response => response.json())
          .then(data => {
            if (data.message === "Login successful!") {
              username = loginUsername;
              document.getElementById("authContainer").style.display = "none";
              document.getElementById("roomContainer").style.display = "block";
              fetchRooms();
            } else {
              alert(data.message);
            }
          })
          .catch(error => console.error("Error:", error));
      } else {
        alert("Please fill in all fields.");
      }
    }

    function registerUser() {
      const regUsername = document.getElementById("signupUsername").value.trim();
      const regPassword = document.getElementById("signupPassword").value.trim();
      if (regUsername && regPassword) {
        fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: regUsername, password: regPassword })
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            if (data.message === "Registration successful!") {
              showLogin();
            }
          })
          .catch(error => console.error("Error:", error));
      } else {
        alert("Please fill in all fields.");
      }
    }

    function logoutUser() {
      fetch("/logout", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          username = "";
          currentRoom = "";
          location.reload();  // Destroy session and reload page
        })
        .catch(error => console.error("Logout error:", error));
    }

    /* ----- ROOM SELECTION FUNCTIONS ----- */
    function fetchRooms() {
      fetch("/rooms")
        .then(response => response.json())
        .then(data => {
          const roomList = document.getElementById("roomList");
          roomList.innerHTML = "";
          data.rooms.forEach(room => {
            const li = document.createElement("li");
            li.textContent = room;
            li.className = "room-item";
            li.onclick = () => joinRoom(room);
            roomList.appendChild(li);
          });
        })
        .catch(error => console.error("Error:", error));
    }

    function createRoom() {
      const newRoom = document.getElementById("newRoomInput").value.trim();
      if (!newRoom) {
        alert("Please enter a room name.");
        return;
      }
      fetch("/rooms", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room_name: newRoom })
      })
        .then(response => response.json())
        .then(data => {
          if (data.message === "Room created successfully!") {
            joinRoom(newRoom);
          } else {
            alert(data.message);
          }
        })
        .catch(error => console.error("Error:", error));
    }

    function joinRoom(room) {
      currentRoom = room;
      socket.emit("join room", room);
      document.getElementById("roomContainer").style.display = "none";
      document.getElementById("chatContainer").style.display = "flex";
      document.getElementById("roomNameDisplay").textContent = room;
      document.getElementById("messages").innerHTML = "";
    }

    function backToRoomSelection() {
      location.reload();  // Reload page to return to room selection
    }

    /* ----- CHAT FUNCTIONS ----- */
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const message = input.value.trim();
      if (message && currentRoom) {
        socket.emit("chat message", { username, message, room: currentRoom });
        input.value = "";
      }
    }

    // Append message to the chat area. If media exists, display accordingly.
    function appendMessage(sender, text, media, mediaType) {
      const li = document.createElement("li");
      li.classList.add("message");
      if (sender === username) {
        li.classList.add("mine");
      } else {
        li.classList.add("theirs");
      }
      let content = `<div class="sender">${sender}</div>`;
      if (text) {
        content += `<div class="text">${text}</div>`;
      }
      if (media) {
        if (mediaType === "image") {
          content += `<div class="media"><img src="${media}" alt="Image" style="max-width:100%;"/></div>`;
        } else if (mediaType === "video") {
          content += `<div class="media"><video controls style="max-width:100%;"><source src="${media}"></video></div>`;
        } else {
          content += `<div class="media"><a href="${media}" target="_blank">Download File</a></div>`;
        }
      }
      li.innerHTML = content;
      const messages = document.getElementById("messages");
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    /* ----- EMOJI PICKER FUNCTIONS ----- */
    function toggleEmojiPicker() {
      const picker = document.getElementById("emojiPicker");
      picker.style.display = picker.style.display === "none" ? "block" : "none";
    }

    function addEmoji(emoji) {
      const input = document.getElementById("messageInput");
      input.value += emoji;
      toggleEmojiPicker();
    }

    /* ----- FILE UPLOAD FUNCTION ----- */
    function uploadFile(input) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const formData = new FormData();
        formData.append("file", file);
        fetch("/upload", {
          method: "POST",
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.fileUrl) {
              // Send a chat message with the media URL and type.
              const msgData = {
                username,
                message: "",
                room: currentRoom,
                media: data.fileUrl,
                mediaType: data.mediaType
              };
              socket.emit("chat message", msgData);
            }
          })
          .catch(err => console.error("File upload error:", err));
      }
    }

    /* ----- DARK/LIGHT MODE TOGGLE ----- */
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      if (document.body.classList.contains("dark-mode")) {
        localStorage.setItem("theme", "dark");
      } else {
        localStorage.setItem("theme", "light");
      }
    }
  </script>
</body>
</html>
